#!/usr/bin/env bash
set -euo pipefail

SCREENSHOTS_DIR="$HOME/pictures/screenshots"
RECORDINGS_DIR="$HOME/videos/recordings"
CHOICE_FILE=/tmp/capture-choice
GEOM_FILE=/tmp/capture-window-geom
GUM="$HOME/.local/share/mise/shims/gum"
JQ="$HOME/.local/share/mise/shims/jq"

# --- TUI mode: just render menu, write choice, exit ---
if [[ "${1:-}" == "--tui" ]]; then
    tput civis
    trap 'tput cnorm' EXIT
    rm -f "$CHOICE_FILE"

    menu_h=12  # 6 options + 2 border + 4 padding
    menu_w=33  # longest line + 4 padding + 2 border
    term_h=$(tput lines)
    term_w=$(tput cols)
    top=$(( (term_h - menu_h) / 2 ))
    left=$(( (term_w - menu_w) / 2 ))
    [[ $top -lt 0 ]] && top=0
    [[ $left -lt 0 ]] && left=0

    "$GUM" style \
        --border rounded \
        --border-foreground 142 \
        --foreground 223 \
        --padding "2 2" \
        --margin "$top 0 0 $left" \
        "1. Screenshot - Fullscreen" \
        "2. Screenshot - Window" \
        "3. Screenshot - Region" \
        "4. Record - Fullscreen" \
        "5. Record - Window" \
        "6. Record - Region"

    read -rsn1 key
    [[ "$key" =~ ^[1-6]$ ]] || exit 0
    echo "$key" > "$CHOICE_FILE"
    exit 0
fi

# --- Orchestrator mode (called by sway binding) ---

# Toggle: if recording, stop it
if pgrep -x wf-recorder > /dev/null; then
    pkill -SIGINT wf-recorder
    notify-send -r 2000 -u low "Recording saved"
    exit 0
fi

mkdir -p "$SCREENSHOTS_DIR" "$RECORDINGS_DIR"

# Save focused window geometry while correct window is focused
swaymsg -t get_tree | "$JQ" -r '.. | select(.focused?) | .rect | "\(.x),\(.y) \(.width)x\(.height)"' > "$GEOM_FILE"

# Launch menu TUI, wait for it to close
kitty --app-id capture-menu --title Capture ~/.local/bin/capture-menu --tui

# Read choice
[[ -f "$CHOICE_FILE" ]] || exit 0
choice=$(<"$CHOICE_FILE")
rm -f "$CHOICE_FILE"

timestamp=$(date +%Y%m%d-%H%M%S)
geom=$(<"$GEOM_FILE")

case "$choice" in
    1)  file="$SCREENSHOTS_DIR/$timestamp.png"
        grim "$file"
        wl-copy -t image/png < "$file"
        notify-send -u low "Screenshot" "Fullscreen saved & copied"
        ;;
    2)  file="$SCREENSHOTS_DIR/$timestamp.png"
        grim -g "$geom" "$file"
        wl-copy -t image/png < "$file"
        notify-send -u low "Screenshot" "Window saved & copied"
        ;;
    3)  file="$SCREENSHOTS_DIR/$timestamp.png"
        grim -g "$(slurp)" "$file"
        wl-copy -t image/png < "$file"
        notify-send -u low "Screenshot" "Region saved & copied"
        ;;
    4)  raw="$RECORDINGS_DIR/$timestamp.mkv"
        notify-send -r 2000 "Recording" "Fullscreen — Print to stop"
        wf-recorder -c ffv1 -x bgr0 -f "$raw"
        ;;
    5)  raw="$RECORDINGS_DIR/$timestamp.mkv"
        notify-send -r 2000 "Recording" "Window — Print to stop"
        wf-recorder -c ffv1 -x bgr0 -g "$geom" -f "$raw"
        ;;
    6)  raw="$RECORDINGS_DIR/$timestamp.mkv"
        region=$(slurp)
        notify-send -r 2000 "Recording" "Region — Print to stop"
        wf-recorder -c ffv1 -x bgr0 -g "$region" -f "$raw"
        ;;
esac

# Convert lossless capture to Discord-friendly VP9
if [[ -n "${raw:-}" && -f "$raw" ]]; then
    out="${raw%.mkv}.webm"
    notify-send -r 2000 "Converting" "Encoding to VP9..."
    ffmpeg -i "$raw" -c:v libvpx-vp9 -crf 4 -b:v 0 -pix_fmt yuv420p \
        -sws_flags lanczos+accurate_rnd+full_chroma_int \
        -deadline good -cpu-used 0 "$out" 2>/dev/null \
        && rm "$raw" \
        && notify-send -r 2000 -u low "Recording saved" "$out" \
        || notify-send -r 2000 "Convert failed" "Raw file kept: $raw"
fi
