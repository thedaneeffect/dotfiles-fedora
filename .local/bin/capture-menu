#!/usr/bin/env bash
set -euo pipefail

SCREENSHOTS_DIR="$HOME/pictures/screenshots"
RECORDINGS_DIR="$HOME/videos/recordings"
CHOICE_FILE=/tmp/capture-choice
GEOM_FILE=/tmp/capture-window-geom
GUM="$HOME/.local/share/mise/shims/gum"
JQ="$HOME/.local/share/mise/shims/jq"

# --- TUI mode: just render menu, write choice, exit ---
if [[ "${1:-}" == "--tui" ]]; then
    tput civis
    trap 'tput cnorm' EXIT
    rm -f "$CHOICE_FILE"

    menu_h=12  # 6 options + 2 border + 4 padding
    menu_w=33  # longest line + 4 padding + 2 border
    term_h=$(tput lines)
    term_w=$(tput cols)
    top=$(( (term_h - menu_h) / 2 ))
    left=$(( (term_w - menu_w) / 2 ))
    [[ $top -lt 0 ]] && top=0
    [[ $left -lt 0 ]] && left=0

    "$GUM" style \
        --border rounded \
        --border-foreground 142 \
        --foreground 223 \
        --padding "2 2" \
        --margin "$top 0 0 $left" \
        "1. Screenshot - Fullscreen" \
        "2. Screenshot - Window" \
        "3. Screenshot - Region" \
        "4. Record - Fullscreen" \
        "5. Record - Window" \
        "6. Record - Region"

    read -rsn1 key
    [[ "$key" =~ ^[1-6]$ ]] || exit 0
    echo "$key" > "$CHOICE_FILE"
    exit 0
fi

# --- Orchestrator mode (called by sway binding) ---

# Toggle: if recording, stop it
if pgrep -x wf-recorder > /dev/null; then
    pkill -SIGINT wf-recorder
    exit 0
fi

mkdir -p "$SCREENSHOTS_DIR" "$RECORDINGS_DIR"

# Save focused window geometry while correct window is focused
swaymsg -t get_tree | "$JQ" -r '.. | select(.focused?) | .rect | "\(.x),\(.y) \(.width)x\(.height)"' > "$GEOM_FILE"

# Launch menu TUI, wait for it to close
kitty --app-id capture-menu --title Capture ~/.local/bin/capture-menu --tui

# Read choice
[[ -f "$CHOICE_FILE" ]] || exit 0
choice=$(<"$CHOICE_FILE")
rm -f "$CHOICE_FILE"

timestamp=$(date +%Y%m%d-%H%M%S)
geom=$(<"$GEOM_FILE")

# --- Screenshots ---
case "$choice" in
    1)  file="$SCREENSHOTS_DIR/$timestamp.png"
        grim "$file"
        wl-copy -t image/png < "$file"
        notify-send -u low "Screenshot" "Fullscreen saved & copied"
        ;;
    2)  file="$SCREENSHOTS_DIR/$timestamp.png"
        grim -g "$geom" "$file"
        wl-copy -t image/png < "$file"
        notify-send -u low "Screenshot" "Window saved & copied"
        ;;
    3)  file="$SCREENSHOTS_DIR/$timestamp.png"
        grim -g "$(slurp)" "$file"
        wl-copy -t image/png < "$file"
        notify-send -u low "Screenshot" "Region saved & copied"
        ;;
    [4-6])
        # --- Record (FFV1 lossless capture) ---
        raw="$RECORDINGS_DIR/$timestamp.mkv"
        case "$choice" in
            4) notify-send -r 2000 "Recording" "Fullscreen — Print to stop"
               wf-recorder -c ffv1 -x bgr0 -f "$raw" || true ;;
            5) notify-send -r 2000 "Recording" "Window — Print to stop"
               wf-recorder -c ffv1 -x bgr0 -g "$geom" -f "$raw" || true ;;
            6) region=$(slurp)
               notify-send -r 2000 "Recording" "Region — Print to stop"
               wf-recorder -c ffv1 -x bgr0 -g "$region" -f "$raw" || true ;;
        esac

        # --- Convert to H.264 with Lanczos chroma downsampling ---
        [[ -f "$raw" ]] || exit 0
        out="${raw%.mkv}.mp4"
        duration_us=$(ffprobe -v quiet -show_entries format=duration \
            -of csv=p=0 "$raw" | sed 's/\.//' | cut -c1-9)
        progress_file=$(mktemp)

        ffmpeg -y -i "$raw" -c:v libx264 -crf 18 -preset fast \
            -pix_fmt yuv420p -sws_flags lanczos+accurate_rnd+full_chroma_int \
            -progress "$progress_file" "$out" 2>/dev/null &
        pid=$!

        while kill -0 "$pid" 2>/dev/null; do
            us=$(grep -oP 'out_time_us=\K[0-9]+' "$progress_file" 2>/dev/null | tail -1) || true
            if [[ -n "${us:-}" && "$duration_us" -gt 0 ]]; then
                pct=$(( us * 100 / duration_us ))
                notify-send -r 2000 -u low -h int:value:"$pct" "Converting" "${pct}%"
            fi
            sleep 0.5
        done
        wait "$pid" || true
        rm -f "$progress_file"

        if [[ -f "$out" && -s "$out" ]]; then
            rm "$raw"
            notify-send -r 2000 -u low "Recording saved" "$out"
        else
            notify-send -r 2000 "Convert failed" "Raw file kept: $raw"
        fi
        ;;
esac
